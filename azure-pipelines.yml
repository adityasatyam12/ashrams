trigger: none

pool:
  name: 'Default'  # Microsoft-hosted agent

stages:

# ---------------- INIT & PLAN ----------------
- stage: Terraform_Plan
  displayName: Terraform Init & Plan
  jobs:
  - job: Plan
    displayName: Terraform Plan
    steps:

    - checkout: self

    # Optional: Check Terraform version
    - task: PowerShell@2
      displayName: Terraform Version
      inputs:
        targetType: 'inline'
        script: terraform --version

    # Terraform Init
    - task: PowerShell@2
      displayName: Terraform Init
      inputs:
        targetType: 'inline'
        script: |
          terraform init

    # Terraform Plan with variables from pipeline
    - task: PowerShell@2
      displayName: Terraform Plan
      inputs:
        targetType: 'inline'
        script: |
          terraform plan `
            -var "subscription_id=$env:ARM_SUBSCRIPTION_ID" `
            -var "client_id=$env:ARM_CLIENT_ID" `
            -var "client_secret=$env:ARM_CLIENT_SECRET" `
            -var "tenant_id=$env:ARM_TENANT_ID"

# ---------------- MANUAL APPROVAL ----------------
- stage: Approval
  displayName: Manual Approval
  dependsOn: Terraform_Plan
  jobs:
  - job: ApprovalJob
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: 'Approve Terraform Apply?'
        timeoutInMinutes: 1440

# ---------------- APPLY ----------------
- stage: Terraform_Apply
  displayName: Terraform Apply
  dependsOn: Approval
  jobs:
  - job: Apply
    displayName: Terraform Apply
    steps:

    - checkout: self

    - task: PowerShell@2
      displayName: Terraform Apply
      inputs:
        targetType: 'inline'
        script: |
          terraform apply -auto-approve `
            -var "subscription_id=$env:ARM_SUBSCRIPTION_ID" `
            -var "client_id=$env:ARM_CLIENT_ID" `
            -var "client_secret=$env:ARM_CLIENT_SECRET" `
            -var "tenant_id=$env:ARM_TENANT_ID"
