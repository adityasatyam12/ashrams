trigger: none

stages:

# ===============================
# STAGE 1 — TERRAFORM INIT & PLAN
# ===============================
- stage: TerraformPlan
  displayName: "Terraform Init & Plan"
  jobs:
  - job: Plan
    displayName: "Run Terraform Init & Plan"
    pool:
      name: 'Default'
    steps:

    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform Init & Plan"
      inputs:
        azureSubscription: "AshramsConnect"
        scriptType: "bash"
        scriptLocation: "inlineScript"
        inlineScript: |
          echo "=== Terraform Init ==="
          terraform init

          echo "=== Terraform Validate ==="
          terraform validate

          echo "=== Terraform Plan ==="
          terraform plan -out tfplan

    # Publish plan file so you can view it later
    - task: PublishBuildArtifacts@1
      displayName: "Upload Terraform Plan Output"
      inputs:
        PathtoPublish: "tfplan"
        ArtifactName: "tfplan"
        publishLocation: "Container"


# ===============================
# STAGE 2 — TERRAFORM APPLY
# (Manual approval recommended)
# ===============================
- stage: TerraformApply
  displayName: "Terraform Apply"
  dependsOn: TerraformPlan
  jobs:
  - job: Apply
    displayName: "Run Terraform Apply"
    pool:
      name: 'Default'
    steps:

    - checkout: self

    - task: AzureCLI@2
      displayName: "Terraform Apply"
      inputs:
        azureSubscription: "AshramsConnect"
        scriptType: "bash"
        scriptLocation: "inlineScript"
        inlineScript: |
          echo "=== Terraform Init ==="
          terraform init

          echo "=== Download Terraform Plan ==="
          # OPTIONAL: If using published plan
          # curl -O $(System.ArtifactsDirectory)/tfplan/tfplan

          echo "=== Terraform Apply ==="
          terraform apply -auto-approve