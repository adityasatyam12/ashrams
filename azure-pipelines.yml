trigger: none

pool:
  name: 'Default'  # or 'Default' if using self-hosted agent

variables:
  terraformVersion: '1.6.6'

stages:

# ---------------- INIT & PLAN ----------------
- stage: Terraform_Plan
  displayName: Terraform Init & Plan
  jobs:
  - job: Plan
    displayName: Terraform Plan
    steps:

    - checkout: self

    # Optional: Check Terraform version
    - task: PowerShell@2
      displayName: Terraform Version
      inputs:
        targetType: 'inline'
        script: terraform --version

    # Terraform Init
    - task: PowerShell@2
      displayName: Terraform Init
      inputs:
        targetType: 'inline'
        script: |
          terraform init

    # Terraform Plan
    - task: PowerShell@2
      displayName: Terraform Plan
      inputs:
        targetType: 'inline'
        script: |
          terraform plan

# ---------------- MANUAL APPROVAL ----------------
- stage: Approval
  displayName: Manual Approval
  dependsOn: Terraform_Plan
  jobs:
  - job: ApprovalJob
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: 'Approve Terraform Apply?'
        timeoutInMinutes: 1440

# ---------------- APPLY ----------------
- stage: Terraform_Apply
  displayName: Terraform Apply
  dependsOn: Approval
  jobs:
  - job: Apply
    displayName: Terraform Apply
    steps:

    - checkout: self

    - task: PowerShell@2
      displayName: Terraform Apply
      inputs:
        targetType: 'inline'
        script: |
          terraform apply -auto-approve
